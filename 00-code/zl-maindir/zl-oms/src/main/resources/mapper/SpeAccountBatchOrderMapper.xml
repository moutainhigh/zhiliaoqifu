<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://10.20.91.130/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.cn.thinkx.oms.specialAccount.mapper.SpeAccountBatchOrderMapper">
	
	<select id="getSpeAccountBatchOrderList" parameterType="SpeAccountBatchOrder" resultType="SpeAccountBatchOrder">
	
			SELECT O.ORDER_ID,
		       O.ORDER_NAME,
		       O.ORDER_TYPE,
		       O.ORDER_DATE,
		       O.ORDER_STAT,
		       O.COMPANY_NAME,
		       O.BIZ_TYPE,
		       O.ACCOUNT_TYPE,
		       O.RESV1,
		       O.RESV2,
		       O.RESV3,
		       O.RESV4,
		       O.RESV5,
		       O.RESV6,
		       O.DATA_STAT,
		       O.REMARKS,
		       O.CREATE_USER,
		       O.UPDATE_USER,
		       O.CREATE_TIME,
		       O.UPDATE_TIME,
		       O.LOCK_VERSION,
		       (SELECT COUNT(L.ORDER_LIST_ID)
              FROM TB_SPEACCOUNT_BATCH_ORDER_LIST L
             WHERE L.DATA_STAT='0' AND O.ORDER_ID = L.ORDER_ID) AS ORDERCOUNT,
             (SELECT SUM(L.AMOUNT)
              FROM TB_SPEACCOUNT_BATCH_ORDER_LIST L
             WHERE L.DATA_STAT = '0'
               AND L.ORDER_ID = O.ORDER_ID) AS SUMAMOUNT,
               NVL(BI.INVOICE_STAT,0) AS INVOICE_STAT
		    FROM TB_SPEACCOUNT_BATCH_ORDER O LEFT JOIN TB_BATCH_INVOICE_ORDER BI
        ON O.ORDER_ID = BI.ORDER_ID
		 WHERE O.DATA_STAT = '0' and O.ORDER_TYPE=#{orderType}
		 <if test="orderId != null and orderId != '' " >
		 AND O.ORDER_ID = #{orderId} 
		 </if>
		 <if test="orderName !=null and orderName != '' ">
		 AND O.ORDER_NAME LIKE '%'|| #{orderName} ||'%' 
		 </if>

		 <if test="orderStat !=null and orderStat != '' ">
		 AND O.ORDER_STAT = #{orderStat} 
		 </if>
		 <if test="bizType !=null and bizType != '' ">
		 AND O.BIZ_TYPE = #{bizType} 
		 </if>
		 <if test="startTime !=null and startTime != '' ">
		 AND O.CREATE_TIME &gt;=  to_date(#{startTime}, 'YYYY-MM-DD HH24:MI:SS') 
		 </if>
		 <if test="endTime !=null and endTime != '' ">
		 AND O.CREATE_TIME &lt;= to_date(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')
		 </if>
		 ORDER BY O.UPDATE_TIME DESC
	
	</select>
	
	<select id="getSpeAccountBatchOrderByOrderId" parameterType="string"  resultType="SpeAccountBatchOrder">
		SELECT O.ORDER_ID,
		       O.ORDER_NAME,
		       O.ORDER_TYPE,
		       O.ORDER_DATE,
		       O.ORDER_STAT,
		       O.COMPANY_NAME,
		       O.BIZ_TYPE,
		       O.ACCOUNT_TYPE,
		       O.RESV1,
		       O.RESV2,
		       O.RESV3,
		       O.RESV4,
		       O.RESV5,
		       O.RESV6,
		       O.DATA_STAT,
		       O.REMARKS,
		       O.CREATE_USER,
		       O.UPDATE_USER,
		       O.CREATE_TIME,
		       O.UPDATE_TIME,
		       O.LOCK_VERSION,
           (SELECT COUNT(L.ORDER_LIST_ID)
              FROM TB_SPEACCOUNT_BATCH_ORDER_LIST L
             WHERE L.DATA_STAT = '0'
               AND L.ORDER_ID = O.ORDER_ID) AS ORDERCOUNT,
           (SELECT COUNT(L.ORDER_LIST_ID)
              FROM TB_SPEACCOUNT_BATCH_ORDER_LIST L
             WHERE L.DATA_STAT = '0'
               AND L.ORDER_ID = O.ORDER_ID
               AND L.ORDER_STAT = '0') AS DISPOSEWAIT,
           (SELECT COUNT(L.ORDER_LIST_ID)
              FROM TB_SPEACCOUNT_BATCH_ORDER_LIST L
             WHERE L.DATA_STAT = '0'
               AND L.ORDER_ID = O.ORDER_ID
               AND L.ORDER_STAT = '00') AS DISPOSESUCCESS,
           (SELECT COUNT(L.ORDER_LIST_ID)
              FROM TB_SPEACCOUNT_BATCH_ORDER_LIST L
             WHERE L.DATA_STAT = '0'
               AND L.ORDER_ID = O.ORDER_ID
               AND L.ORDER_STAT = '99') AS DISPOSEFAIL,
           (SELECT SUM(L.AMOUNT)
              FROM TB_SPEACCOUNT_BATCH_ORDER_LIST L
             WHERE L.DATA_STAT = '0'
               AND L.ORDER_ID = O.ORDER_ID) AS SUMAMOUNT
	      FROM TB_SPEACCOUNT_BATCH_ORDER O
	     WHERE O.DATA_STAT = '0'  AND O.ORDER_ID= #{orderId}
	  
	</select>
	
	<select id="getSpeAccountBatchOrderById" parameterType="string" resultType="SpeAccountBatchOrder">
		SELECT O.ORDER_ID,
		       O.ORDER_NAME,
		       O.ORDER_TYPE,
		       O.ORDER_DATE,
		       O.ORDER_STAT,
		       O.COMPANY_NAME,
		       O.BIZ_TYPE,
		       O.ACCOUNT_TYPE,
		       O.RESV1,
		       O.RESV2,
		       O.RESV3,
		       O.RESV4,
		       O.RESV5,
		       O.RESV6,
		       O.DATA_STAT,
		       O.REMARKS,
		       O.CREATE_USER,
		       O.UPDATE_USER,
		       O.CREATE_TIME,
		       O.UPDATE_TIME,
		       O.LOCK_VERSION
	  FROM TB_SPEACCOUNT_BATCH_ORDER O
	 WHERE O.ORDER_ID = #{orderId}
	</select>
	
	<insert id="addSpeAccountBatchOrder" parameterType="SpeAccountBatchOrder" >
			INSERT INTO TB_SPEACCOUNT_BATCH_ORDER
		   (ORDER_ID,
	       ORDER_NAME,
	       ORDER_TYPE,
	       ORDER_DATE,
	       ORDER_STAT,
	       COMPANY_NAME,
	       BIZ_TYPE,
	       ACCOUNT_TYPE,
	       RESV1,
	       RESV2,
	       RESV3,
	       RESV4,
	       RESV5,
	       RESV6,
	       DATA_STAT,
	       REMARKS,
	       CREATE_USER,
	       UPDATE_USER,
	       CREATE_TIME,
	       UPDATE_TIME,
	       LOCK_VERSION
		    )
		 VALUES
		   (
		   #{orderId},
		   #{orderName,jdbcType=VARCHAR},
		   #{orderType,jdbcType=VARCHAR},
		   sysdate,
		   #{orderStat,jdbcType=VARCHAR},
		   #{companyName,jdbcType=VARCHAR},
            #{bizType,jdbcType=VARCHAR},
            #{accountType,jdbcType=VARCHAR},
            #{resv1,jdbcType=VARCHAR},
            #{resv2,jdbcType=VARCHAR},
            #{resv3,jdbcType=VARCHAR},
            #{resv4,jdbcType=VARCHAR},
            #{resv5,jdbcType=VARCHAR},
            #{resv6,jdbcType=VARCHAR},
		   '0',
		   #{remarks,jdbcType=VARCHAR},
           #{createUser,jdbcType=VARCHAR},
           #{updateUser,jdbcType=VARCHAR},
           #{createTime,jdbcType=BIGINT},
           #{updateTime,jdbcType=BIGINT},
           '0'
		   )
	</insert>
	
	<update id="updateSpeAccountBatchOrder"  parameterType="SpeAccountBatchOrder" >
		UPDATE TB_SPEACCOUNT_BATCH_ORDER
	    <trim prefix="SET" suffixOverrides=","> 
	        <if test="orderName != null and orderName != '' ">ORDER_NAME   = #{orderName,jdbcType=VARCHAR},</if>
	        <if test="orderType != null and orderType != '' ">ORDER_TYPE   = #{orderType,jdbcType=VARCHAR},</if>
	        <if test="orderStat != null and orderStat != '' ">ORDER_STAT   = #{orderStat,jdbcType=VARCHAR},</if>
	        <if test="dataStat != null and dataStat != '' ">DATA_STAT    = #{dataStat,jdbcType=VARCHAR},</if>
	        <if test="remarks != null and remarks != '' ">REMARKS      = #{remarks,jdbcType=VARCHAR},</if>
	        <if test="updateUser != null and updateUser != '' ">UPDATE_USER  = #{updateUser,jdbcType=VARCHAR},</if>
	        <if test="companyName != null and companyName != '' ">COMPANY_NAME  = #{companyName,jdbcType=VARCHAR},</if>
	        <if test="bizType != null and bizType != '' ">BIZ_TYPE  = #{bizType,jdbcType=VARCHAR},</if>
	        UPDATE_TIME  = #{updateTime,jdbcType=BIGINT},
	        LOCK_VERSION = LOCK_VERSION+1 
	        </trim>
	  WHERE ORDER_ID = #{orderId,jdbcType=VARCHAR} AND LOCK_VERSION = ${lockVersion}
	</update>
	
	
	<update id="deleteSpeAccountBatchOrder" parameterType="string">
	 UPDATE TB_SPEACCOUNT_BATCH_ORDER SET DATA_STAT = '1',LOCK_VERSION=LOCK_VERSION+1 WHERE ORDER_ID = #{orderId}
	</update>
	

</mapper>
